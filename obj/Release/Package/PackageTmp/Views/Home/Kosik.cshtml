@using LadowebservisMVC.Util

@{
    // Track IDs to avoid rendering duplicate entries
    var seenIds = new System.Collections.Generic.HashSet<string>(System.StringComparer.OrdinalIgnoreCase);
}

<div class="container-fluid card py-4">
    <div class="row justify-content-center">
        <div class="col-12 col-md-10">
            <h2 class="mb-3 text-center" style="color:#ffffff;text-shadow:1px 1px 4px #5d33fb">Váš nákupný košík</h2>
            <div class="text-center mt-4">
                <a href="@Url.Action("MemberInfo","Home")" class="btn btn-secondary me-2">Späť do členskej sekcie</a>
                <a href='@Url.Action("Zdravie","Home", new { area = "Ladowebservis" })' class="btn btn-primary btn-md tlacitko-moje">Späť na úvod</a>
            </div>
            <div id="cartReview" class="card p-3 mb-3">
                <ul id="cartReviewList" class="list-group mb-2">
                    <!-- items rendered by JS -->
                </ul>
                <div class="d-flex flex-column flex-sm-row justify-content-between align-items-center">

                    <div class="mb-2 mb-sm-0">
                        Celková suma: €<span id="cartReviewTotal">0.00</span>
                        <button id="clear-cart-btn" class="btn btn-sm btn-danger ms-2">Vyprázdniť košík</button>
                    </div>
                </div>

                <p class="mb-3 text-center" style="color:#5d33fb;text-shadow:1px 1px 4px #5d33fb">
                    Po kliknutí tlačidla 👉Prejsť k platbe<br />si na zabezpečenej stránke Stripe opäť upravte alebo pridajte produkty o ktoré máte záujem,<br />nakoniec vyberte spôsob platby,vašu dodaciu adresu a zaplaťte. <br />
                    Nezabudnite vložiť propagačný kód👉 FRIENDS25 👉aby ste mali 10% zľavu z celého nákupu vrátane DPH.<br /> Ďakujeme Vám za nákup a želáme pevné zdravie!
                </p>

                <!-- Payment procedure help thumbnail: clicking opens enlarged image via Fancybox (included in layout) -->
                <div class="text-center mb-3">
                    <p class="small text-muted">Potrebujete pomoc s platbou? Kliknite na obrázok pre návod.</p>
                    <a data-fancybox="payment-help" data-caption="Payment procedure" href="@Url.Content("~/Image/Postup platby.png")" aria-label="Open payment procedure image">
                        <img src="@Url.Content("~/Image/Postup platby.png")" alt="Payment procedure" class="img-thumbnail" style="max-width:100px;cursor:pointer;" />
                    </a>
                </div>

                <stripe-buy-button buy-button-id="buy_btn_1Qr3pPHrPMzQ1ua8bEe7WMIU"
                                   publishable-key="pk_live_51P80kcHrPMzQ1ua8JUHSe4iUQ9sLHonQMmFzwyRKnq2xTpB6mhuJVc4OdBKa04BJzpsjjliSrBoNnftkBxwntFF300mePdWSx3">
                </stripe-buy-button>
            </div>

            <!-- Available products: show catalog and allow adding to cart -->
            <div id="availableProducts" class="card p-3 mb-3">
                <h3 class="mb-3">Dostupné produkty</h3>
                <div class="row">
                    @foreach (var p in ProductCatalog.GetAll())
                    {
                        @* skip duplicates by Id only *@
                        if (p == null) { continue; }
                        var id = (p.Id ?? string.Empty).Trim();
                        if (string.IsNullOrEmpty(id)) { continue; }

                        // If we've already rendered the same id, skip to avoid duplicates
                        if (seenIds.Contains(id)) { continue; }

                        // mark as seen
                        seenIds.Add(id);

                        <div class="col-12 col-sm-6 col-md-4 mb-3 products" data-product-id="@p.Id" data-product-name="@p.Name" data-product-image="@p.Image">
                            <div class="card p-2 text-center product-card h-100 d-flex flex-column">
                                <img src="@p.Image" alt="@p.Name" class="img-fluid mx-auto" style="max-height:100px;object-fit:contain;" />
                                <h4 class="mt-2">@p.Name</h4>
                                <p>€@String.Format("{0:0.00}", p.Price)</p>
                                <div class="mt-auto d-flex gap-2 justify-content-center align-items-center">
                                    <a class="btn btn-sm btn-info" href="@Url.Action("Produkty", "Home", new { id = p.Id })" title="Detail produktu">Detail</a>
                                    <button type="button" class="btn btn-sm btn-dark add-to-cart btn-block" data-id="@p.Id">Pridať do košíka</button>
                                    <button type="button" class="product-heart btn btn-link" data-id="@p.Id" title="Pridať do obľúbených" aria-label="Pridať do obľúbených">
                                        <i class="fa fa-heart" aria-hidden="true"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>

            <!-- Order form: bank transfer (posts to PlaceOrder) -->
            @*<div class="card p-3 mb-3">
        <h4>Objednať - bankový prevod</h4>
        <p>Vyplňte Vaše kontaktné údaje a potvrďte objednávku. V potvrdení obdržíte inštrukcie na prevod.</p>*@

        </div>

    </div>
    </div>
    

    <style>
        /* Fly-to-cart image animation */
        .lws-fly-img {
            position: absolute !important;
            pointer-events: none;
            z-index: 9999;
            border-radius: 6px;
            transition: transform 0.8s ease-in-out, opacity 0.8s ease-in-out;
            opacity: 1;
            will-change: transform, opacity;
        }
        /* small heart in product card */
        .product-card { position: relative; }
        .product-card .product-heart {
            position: absolute;
            bottom: 6px;
            right: 6px;
            /* minimize footprint */
            padding: 2px;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            border: 0;
            line-height: 1;
        }
        /* smaller heart glyph */
        .product-card .product-heart .fa-heart { font-size: 12px; color: #e25555; }

        /* reduce focus outline to subtle ring for accessibility */
        .product-card .product-heart:focus { outline: none; box-shadow: 0 0 0 3px rgba(94,33,255,0.15); border-radius: 4px; }

        /* Responsive adjustments */
        @@media (max-width: 576px) {
            .product-card .product-heart { bottom: 12px; right: 12px; }
            .add-to-cart.btn-block { display: block; width: 100%; }
        }
    </style>

@section scripts {
    <script>
        (function () {
            var STORAGE_KEY = 'lws_cart_v1';

            function loadCart() {
                try {
                    return JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
                } catch (e) {
                    return {};
                }
            }

            function saveCart(cart) {
                try { localStorage.setItem(STORAGE_KEY, JSON.stringify(cart)); } catch (e) { }
            }

            function getProductPrice(key) {
                var catalog = window.__lws_products || {};
                // try id-based lookup
                if (catalog && catalog[key] && catalog[key].Price) return parseFloat(catalog[key].Price) || 0;
                // try match by Name
                if (catalog) {
                    for (var id in catalog) {
                        if (!catalog.hasOwnProperty(id)) continue;
                        var it = catalog[id];
                        if (it && it.Name === key && it.Price) return parseFloat(it.Price) || 0;
                    }
                }
                // fallback hardcoded prices
                return ({ 'BalanceTest': 195.00, 'BalanceOil': 55.00, 'Zinobiotic': 33.00, 'ZinzinoXtend': 34.00 }[key] || 0);
            }

            function getCartTotals(cart) {
                var subtotal = 0, totalQty = 0;
                Object.keys(cart).forEach(function (k) {
                    var item = cart[k];
                    if (!item || (item.quantity || 0) <= 0) return;
                    var q = item.quantity || 0;
                    totalQty += q;
                    subtotal += (getProductPrice(k) * q);
                });
                // Apply 10% discount to whole cart
                var discount = subtotal * 0.10;
                var total = subtotal - discount;
                return { subtotal: subtotal, total: total, discount: discount, totalQty: totalQty };
            }

            function render() {
                var cart = loadCart();
                var list = document.getElementById('cartReviewList');
                var totalEl = document.getElementById('cartReviewTotal');
                if (!list || !totalEl) return;
                var listEl = list; // cache for analyzer
                listEl.innerHTML = '';

                var hasItems = false;
                var catalog = window.__lws_products || {};

                Object.keys(cart).forEach(function (k) {
                    var item = cart[k];
                    if (!item || (item.quantity || 0) <= 0) return;
                    hasItems = true;

                    var productInfo = catalog && catalog[k] ? catalog[k] : null;

                    var displayName = productInfo && productInfo.Name ? productInfo.Name : k;
                    var imgSrc = item.image || (productInfo && productInfo.Image) || ('/Image/' + k + '.png');
                    var unitPrice = getProductPrice(k);

                    var qtyVal = item.quantity || 0;
                    var discountedUnit = unitPrice * 0.9;
                    var lineTotal = (discountedUnit * qtyVal).toFixed(2);

                    // short description from catalog if present
                    var shortDesc = productInfo && productInfo.Description ? String(productInfo.Description) : '';

                    var li = document.createElement('li');
                    li.className = 'list-group-item d-flex align-items-center';

                    var img = document.createElement('img');
                    img.src = imgSrc;
                    img.alt = displayName;
                    img.style.width = '120px';
                    img.style.marginRight = '20px';

                    var name = document.createElement('div');
                    var html = '<strong>' + displayName + '</strong><br/>' +
                               'ID: ' + k + '<br/>' +
                               'Cena za ks: <span style="text-decoration:line-through;color:#999;">€' + unitPrice.toFixed(2) + '</span> ' +
                               '<strong>€' + discountedUnit.toFixed(2) + '</strong><br/>' +
                               'Počet: ' + qtyVal + ' &nbsp; Suma: €' + lineTotal + '<br/>';
                    if (shortDesc) {
                        html += '<small class="text-muted">' + shortDesc + '</small><br/>';
                    }
                    name.innerHTML = html;

                    var controls = document.createElement('div');
                    controls.style.marginLeft = 'auto';

                    // detail button opens Produkty page
                    var detail = document.createElement('a');
                    detail.href = '/Home/Produkty?id=' + encodeURIComponent(k);
                    detail.className = 'btn btn-sm btn-info';
                    detail.textContent = 'Detail';
                    detail.style.marginRight = '8px';

                    var qty = document.createElement('span');
                    qty.textContent = 'Ks: ' + qtyVal;
                    qty.style.marginRight = '12px';

                    var del = document.createElement('button');
                    del.type = 'button';
                    del.className = 'btn btn-sm btn-danger';
                    del.textContent = 'X';
                    (function (key) {
                        del.addEventListener('click', function (e) {
                            e.preventDefault(); e.stopPropagation();
                            var cartNow = loadCart();
                            if (cartNow && cartNow[key]) { delete cartNow[key]; saveCart(cartNow); }
                            render();
                            // notify header to re-render
                            if (window.lwsRenderCartHeader) window.lwsRenderCartHeader();
                        });
                    })(k);

                    controls.appendChild(detail);
                    controls.appendChild(qty);
                    controls.appendChild(del);

                    li.appendChild(img);
                    li.appendChild(name);
                    li.appendChild(controls);

                    listEl.appendChild(li);
                });

                var totals = getCartTotals(cart);

                // remove previous summary rows if any
                var parent = listEl.parentNode;
                var prevSubtotal = document.getElementById('cartSubtotalRow'); if (prevSubtotal) prevSubtotal.parentNode.removeChild(prevSubtotal);
                var prevDiscount = document.getElementById('cartDiscountRow'); if (prevDiscount) prevDiscount.parentNode.removeChild(prevDiscount);
                var prevTotal = document.getElementById('cartTotalRow'); if (prevTotal) prevTotal.parentNode.removeChild(prevTotal);

                // Add subtotal row
                var subtotalRow = document.createElement('div');
                subtotalRow.className = 'row';
                subtotalRow.id = 'cartSubtotalRow';
                subtotalRow.innerHTML = '<div class="col text-end">Medzisúčet:</div><div class="col-auto"><strong>€' + totals.subtotal.toFixed(2) + '</strong></div>';
                parent.appendChild(subtotalRow);

                if (totals.discount > 0) {
                    var discountRow = document.createElement('div');
                    discountRow.className = 'row';
                    discountRow.id = 'cartDiscountRow';
                    discountRow.innerHTML = '<div class="col text-end" style="color:#d9534f;">Zľava 10%:</div><div class="col-auto" style="color:#d9534f;"><strong>-€' + (totals.discount).toFixed(2) + '</strong></div>';
                    parent.appendChild(discountRow);
                }

                var totalRow = document.createElement('div');
                totalRow.className = 'row';
                totalRow.id = 'cartTotalRow';
                totalRow.innerHTML = '<div class="col text-end"><strong>Celková suma:</strong></div><div class="col-auto"><strong style="font-size:1.1em;">€' + totals.total.toFixed(2) + '</strong></div>';
                parent.appendChild(totalRow);

                totalEl.textContent = totals.total.toFixed(2);

                // populate hidden input for bank form only
                var cartJson = JSON.stringify(cart || {});
                var elBank = document.getElementById('cartJsonBank'); if (elBank && elBank instanceof HTMLInputElement) elBank.value = cartJson;

                // enable/disable bank button
                var bankBtn = document.getElementById('bank-button'); if (bankBtn && bankBtn instanceof HTMLButtonElement) bankBtn.disabled = !hasItems;
            }

            function addToCartById(id) {
                if (!id) return;
                var cart = loadCart();
                var products = window.__lws_products || {};
                var p = products[id];
                if (!p) return;
                var item = cart[id] || { quantity: 0, image: p.Image };
                // always set quantity to 1 (only sell single piece per product)
                item.quantity = 1;
                cart[id] = item;
                saveCart(cart);
                render();
                if (window.lwsRenderCartHeader) window.lwsRenderCartHeader();
            }

            // attach add-to-cart handlers for product buttons rendered server-side
            document.addEventListener('click', function (e) {
                var btn = e.target;
                // walk up to button if inner element clicked
                while (btn && !btn.classList && btn.parentNode) btn = btn.parentNode;
                if (btn && btn.classList && btn.classList.contains('add-to-cart')) {
                    var id = btn.getAttribute('data-id');
                    if (id) { addToCartById(id); return; }
                    // fallback: resolve id from enclosing .products data attributes
                    var section = btn.closest && btn.closest('.products');
                    if (section) {
                        var dataId = section.getAttribute('data-product-id') || section.getAttribute('data-id');
                        if (dataId) { addToCartById(dataId); return; }
                        var name = section.getAttribute('data-product-name');
                        if (name) {
                            // resolve name to id via catalog
                            var catalog = window.__lws_products || {};
                            for (var k in catalog) {
                                if (!catalog.hasOwnProperty(k)) continue;
                                if (catalog[k] && catalog[k].Name === name) { addToCartById(k); return; }
                            }
                        }
                    }
                }
            });

            var clearBtn = document.getElementById('clear-cart-btn');
            if (clearBtn) {
                clearBtn.addEventListener('click', function (e) { e.preventDefault(); localStorage.removeItem(STORAGE_KEY); render(); if (window.lwsRenderCartHeader) window.lwsRenderCartHeader(); });
            }

            // expose hook for header script to call when it changes the cart
            window.lwsRenderCartPage = render;

            // init
            render();
        })();
    </script>
}





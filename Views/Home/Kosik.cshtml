@using LadowebservisMVC.Util

@{
    // Track IDs to avoid rendering duplicate entries
    var seenIds = new System.Collections.Generic.HashSet<string>(System.StringComparer.OrdinalIgnoreCase);
}

<div class="container-fluid card py-4">
    <div class="row justify-content-center">
        <div class="col-12 col-md-10">
            <h2 style="font-size:20px;color:#ffffff;text-shadow:1px 1px 4px #5d33fb;text-align:center">
                Vitajte priatelia!<br />Toto je stránka nákupného košíka kde si môžte skontrolovať čo sa v košíku ocitlo a dostupné produkty pridávať,
                <br />editovať,vložiť do obľúbených a pod.
                <br />Prejsť k platbe môžte aj priamo stlačením tlačidla bez zadávanie do košíka<br />
                <stripe-buy-button buy-button-id="buy_btn_1SgujHHrPMzQ1ua8771vUUL4"
                                   publishable-key="pk_live_51P80kcHrPMzQ1ua8JUHSe4iUQ9sLHonQMmFzwyRKnq2xTpB6mhuJVc4OdBKa04BJzpsjjliSrBoNnftkBxwntFF300mePdWSx3">
                </stripe-buy-button><br /> Kód👉 NOVYROK26 je možné uplatniť len na akciové produkty a to: Balanceoil+ 300ml, BalanceTest, Vitamin D test alebo ich kombináciou...
            </h2>
                <div class="text-center mt-4">
                    <a href="@Url.Action("Login","Home")" class="btn btn-secondary me-2">Prihlásenie do členskej sekcie</a>
                    <a href='@Url.Action("Favorites","Home")' class="btn btn-secondary me-2">Obľúbené produkty</a>
                    <a href='@Url.Action("Zdravie","Home", new { area = "Ladowebservis" })' class="btn btn-primary btn-md tlacitko-moje">Späť na úvod</a>
                    <button type="button"
                            class="btn btn-primary btn-sm"
                            style="margin-left:.5rem;"
                            onclick="openSideCart()">
                        Skontrolovať položky v košíku
                    </button>
                </div>
                <!-- Available products: show catalog and allow adding to cart -->
                <div id="availableProducts" class="card p-3 mb-3">
                    <h3 class="mb-3">Dostupné produkty</h3>
                    <div class="row">
                        @foreach (var p in ProductCatalog.GetAll())
                        {
                            @* skip duplicates by Id only *@
                            if (p == null) { continue; }
                            var id = (p.Id ?? string.Empty).Trim();
                            if (string.IsNullOrEmpty(id)) { continue; }

                            // If we've already rendered the same id, skip to avoid duplicates
                            if (seenIds.Contains(id)) { continue; }

                            // mark as seen
                            seenIds.Add(id);

                            <div class="col-12 col-sm-6 col-md-4 mb-3 products" data-product-id="@p.Id" data-product-name="@p.Name" data-product-image="@p.Image">
                                <div class="card p-2 text-center product-card h-100 d-flex flex-column">
                                    <img src="@p.Image" alt="@p.Name" class="img-fluid mx-auto" style="max-height:100px;object-fit:contain;" />
                                    <h4 class="mt-2">@p.Name</h4>
                                    <p>€@String.Format("{0:0.00}", p.Price)</p>
                                    <div class="mt-auto d-flex gap-2 justify-content-center align-items-center">
                                        <a class="btn btn-sm btn-info" href="@Url.Action("Produkty", "Home", new { id = p.Id })" title="Detail produktu">Detail</a>
                                        <button type="button" class="btn btn-sm btn-dark add-to-cart btn-block" data-id="@p.Id">Pridať do košíka</button>
                                        <button type="button" class="product-heart btn btn-link" data-id="@p.Id" title="Pridať do obľúbených" aria-label="Pridať do obľúbených">
                                            <i class="fa fa-heart" aria-hidden="true"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>

                <div id="cartReview" class="card p-3 mb-3">
                    <h3 class="mb-3">Tu je zoznam produktov v košíku</h3>
                    <ul id="cartReviewList" class="list-group mb-2">
                        <!-- items rendered by JS -->
                    </ul>
                    <div class="d-flex flex-column flex-sm-row justify-content-between align-items-center">

                        <div class="mb-2 mb-sm-0">
                            Celková suma: €<span id="cartReviewTotal">0.00</span>
                            <button id="clear-cart-btn" class="btn btn-sm btn-danger ms-2">Vyprázdniť košík</button>
                        </div>
                    </div>

                    <p class="mb-3 text-center" style="color:#5d33fb;text-shadow:1px 1px 4px #5d33fb">
                        Po kliknutí tlačidla 👉Prejsť k platbe<br />rovno prechádzate na platobný proces na zabezpečenej stránke Stripe kde si musíte upraviť produkty o ktoré máte záujem,<br />potom si vyberte spôsob platby,vašu adresu a zaplaťte. <br />
                        Nezabudnite vložiť propagačný kód👉 NOVYROK26 👉aby ste mali 10% zľavu.To je všetko.<br /> Ďakujeme Vám za nákup a želáme pevné zdravie!
                    </p>

                    <!-- Oriflame + IT service options info -->
                    <div class="alert alert-info" style="margin-bottom:1.5rem;">
                        <h4 style="margin-top:0;">Oriflame produkty a IT služby</h4>
                        <p class="small">
                            Ak máte záujem objednať si aj inú kozmetiku alebo doplnky Oriflame, môžete:
                        </p>
                        <ul class="small" style="padding-left:18px;">
                            <li>prejsť na oficiálny Oriflame katalóg cez položku <strong>Partnery → Oriflame katalóg</strong> v hornej navigácii a vytvoriť objednávku priamo tam, alebo</li>
                            <li>napísať nám svoj zoznam Oriflame produktov na e‑mail <a href="mailto:info@ladowebservis.sk">info@ladowebservis.sk</a> a my vás budeme kontaktovať s ďalšími možnosťami.</li>
                        </ul>
                        <p class="small" style="margin-bottom:0;">
                            V prípade záujmu o IT služby (oprava PC, nastavenie systému, webové riešenia a pod.)
                            napíšte stručný popis problému na adresu <a href="mailto:podpora@ladowebservis.sk">podpora@ladowebservis.sk</a> a náš IT servis vás bude kontaktovať e‑mailom.
                        </p>
                    </div>

                    <!-- Payment procedure help thumbnail: clicking opens enlarged image via Fancybox (included in layout) -->
                    <div class="text-center mb-3">
                        <p class="small text-muted">Potrebujete pomoc s platbou? Kliknite na obrázok pre návod cez platobnú bránu Stripe.</p>
                        <a data-fancybox="payment-help" data-caption="Payment procedure" href="@Url.Content("~/Image/Postup platby.png")" aria-label="Open payment procedure image">
                            <img src="@Url.Content("~/Image/Postup platby.png")" alt="Payment procedure" class="img-thumbnail" style="max-width:100px;cursor:pointer;" />
                        </a>
                    </div>


                  


                </div>

                <!-- Order form: bank transfer (posts to PlaceOrder) -->


</div>

    </div>
    </div>
    

    <style>
        /* Fly-to-cart image animation */
        .lws-fly-img {
            position: absolute !important;
            pointer-events: none;
            z-index: 9999;
            border-radius: 6px;
            transition: transform 0.8s ease-in-out, opacity 0.8s ease-in-out;
            opacity: 1;
            will-change: transform, opacity;
        }
        /* small heart in product card */
        .product-card { position: relative; }
        .product-card .product-heart {
            position: absolute;
            bottom: 6px;
            right: 6px;
            /* minimize footprint */
            padding: 2px;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            border: 0;
            line-height: 1;
        }
        /* smaller heart glyph */
        .product-card .product-heart .fa-heart { font-size: 12px; color: #e25555; }

        /* reduce focus outline to subtle ring for accessibility */
        .product-card .product-heart:focus { outline: none; box-shadow: 0 0 0 3px rgba(94,33,255,0.15); border-radius: 4px; }

        /* Responsive adjustments */
        @@media (max-width: 576px) {
            .product-card .product-heart { bottom: 12px; right: 12px; }
            .add-to-cart.btn-block { display: block; width: 100%; }
        }

        /* Hide empty cart message row (reuse existing class for convenience) */
        .d-none { display: none !important; }
    </style>

@section scripts {
    <script>
        function openSideCart() {
            try {
                var cart = document.getElementById('side-cart');
                var overlay = document.getElementById('cart-overlay');
                if (!cart || !overlay) return;
                cart.classList.add('open');
                overlay.classList.add('open');
                cart.setAttribute('aria-hidden', 'false');
                overlay.setAttribute('aria-hidden', 'false');
                cart.focus();
            } catch (e) { }
        }

        (function () {
            var STORAGE_KEY = 'lws_cart_v1';

            function loadCart() {
                try {
                    return JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
                } catch (e) {
                    return {};
                }
            }

            function saveCart(cart) {
                try { localStorage.setItem(STORAGE_KEY, JSON.stringify(cart)); } catch (e) { }
            }

            function getProductPrice(key) {
                var catalog = window.__lws_products || {};
                // try id-based lookup
                if (catalog && catalog[key] && catalog[key].Price) return parseFloat(catalog[key].Price) || 0;
                // try match by Name
                if (catalog) {
                    for (var id in catalog) {
                        if (!catalog.hasOwnProperty(id)) continue;
                        var it = catalog[id];
                        if (it && it.Name === key && it.Price) return parseFloat(it.Price) || 0;
                    }
                }
                // fallback hardcoded prices
                return ({ 'BalanceTest': 195.00, 'BalanceOil': 55.00, 'Zinobiotic': 33.00, 'ZinzinoXtend': 34.00 }[key] || 0);
            }

            function getCartTotals(cart) {
                var subtotal = 0, totalQty = 0, discount = 0;
                Object.keys(cart).forEach(function (k) {
                    var item = cart[k];
                    if (!item || (item.quantity || 0) <= 0) return;
                    var q = item.quantity || 0;
                    totalQty += q;
                    var unit = getProductPrice(k);
                    var line = unit * q;
                    subtotal += line;
                    // 10% discount only when line amount (unit * quantity) > 50€
                    if (line > 50) {
                        discount += line * 0.10;
                    }
                });
                var total = subtotal - discount;
                return { subtotal: subtotal, total: total, discount: discount, totalQty: totalQty };
            }

            function changeQuantity(id, delta) {
                if (!id || !delta) return;
                var cart = loadCart();
                var item = cart[id];
                if (!item) return;
                var current = item.quantity || 0;
                var next = current + delta;
                if (next <= 0) {
                    delete cart[id];
                } else {
                    item.quantity = next;
                    cart[id] = item;
                }
                saveCart(cart);
                render();
                if (window.lwsRenderCartHeader) window.lwsRenderCartHeader();
            }

            function render() {
                var cart = loadCart();
                var list = document.getElementById('cartReviewList');
                var totalEl = document.getElementById('cartReviewTotal');
                if (!list || !totalEl) return;
                var listEl = list;
                listEl.innerHTML = '';

                var hasItems = false;
                var catalog = window.__lws_products || {};

                Object.keys(cart).forEach(function (k) {
                    var item = cart[k];
                    if (!item || (item.quantity || 0) <= 0) return;
                    hasItems = true;

                    var productInfo = catalog && catalog[k] ? catalog[k] : null;
                    var displayName = productInfo && productInfo.Name ? productInfo.Name : k;
                    var imgSrc = item.image || (productInfo && productInfo.Image) || ('/Image/' + k + '.png');
                    var unitPrice = getProductPrice(k);

                    var qtyVal = item.quantity || 0;
                    var baseLine = unitPrice * qtyVal;
                    var qualifiesForDiscount = baseLine > 50;
                    var lineTotal = qualifiesForDiscount
                        ? (baseLine * 0.9).toFixed(2)
                        : baseLine.toFixed(2);

                    var li = document.createElement('li');
                    li.className = 'list-group-item d-flex align-items-center';

                    var img = document.createElement('img');
                    img.src = imgSrc;
                    img.alt = displayName;
                    img.style.width = '120px';
                    img.style.marginRight = '20px';

                    var name = document.createElement('div');
                    var html = '<strong>' + displayName + '</strong><br/>' +
                               'ID: ' + k + '<br/>';
                    if (qualifiesForDiscount) {
                        html += 'Cena za ks: <span style="text-decoration:line-through;color:#999;">€' +
                                unitPrice.toFixed(2) +
                                '</span> <strong>€' + (unitPrice * 0.9).toFixed(2) + '</strong><br/>';
                    } else {
                        html += 'Cena za ks: <strong>€' + unitPrice.toFixed(2) + '</strong><br/>';
                    }
                    html += 'Počet: ' + qtyVal + ' &nbsp; Suma: €' + lineTotal + '<br/>';
                    name.innerHTML = html;

                    var controls = document.createElement('div');
                    controls.style.marginLeft = 'auto';
                    controls.className = 'text-end';

                    var qtyControls = document.createElement('div');
                    qtyControls.className = 'btn-group btn-group-sm';

                    var decBtn = document.createElement('button');
                    decBtn.type = 'button';
                    decBtn.className = 'btn btn-default';
                    decBtn.textContent = '-';
                    decBtn.title = 'Znížiť množstvo';
                    decBtn.addEventListener('click', function (e) {
                        e.preventDefault(); e.stopPropagation();
                        changeQuantity(k, -1);
                    });

                    var qtyLabel = document.createElement('span');
                    qtyLabel.className = 'btn btn-light disabled';
                    qtyLabel.textContent = qtyVal;

                    var incBtn = document.createElement('button');
                    incBtn.type = 'button';
                    incBtn.className = 'btn btn-default';
                    incBtn.textContent = '+';
                    incBtn.title = 'Zvýšiť množstvo';
                    incBtn.addEventListener('click', function (e) {
                        e.preventDefault(); e.stopPropagation();
                        changeQuantity(k, 1);
                    });

                    qtyControls.appendChild(decBtn);
                    qtyControls.appendChild(qtyLabel);
                    qtyControls.appendChild(incBtn);

                    var detail = document.createElement('a');
                    detail.href = '/Home/Produkty?id=' + encodeURIComponent(k);
                    detail.className = 'btn btn-sm btn-info';
                    detail.textContent = 'Detail';
                    detail.style.margin = '0 8px 0 12px';

                    var del = document.createElement('button');
                    del.type = 'button';
                    del.className = 'btn btn-sm btn-danger';
                    del.textContent = 'X';
                    (function (key) {
                        del.addEventListener('click', function (e) {
                            e.preventDefault(); e.stopPropagation();
                            var cartNow = loadCart();
                            if (cartNow && cartNow[key]) { delete cartNow[key]; saveCart(cartNow); }
                            render();
                            if (window.lwsRenderCartHeader) window.lwsRenderCartHeader();
                        });
                    })(k);

                    controls.appendChild(qtyControls);
                    controls.appendChild(detail);
                    controls.appendChild(del);

                    li.appendChild(img);
                    li.appendChild(name);
                    li.appendChild(controls);

                    listEl.appendChild(li);
                });

                var totals = getCartTotals(cart);
                var parent = listEl.parentNode;
                var prevSubtotal = document.getElementById('cartSubtotalRow'); if (prevSubtotal) prevSubtotal.parentNode.removeChild(prevSubtotal);
                var prevDiscount = document.getElementById('cartDiscountRow'); if (prevDiscount) prevDiscount.parentNode.removeChild(prevDiscount);
                var prevTotal = document.getElementById('cartTotalRow'); if (prevTotal) prevTotal.parentNode.removeChild(prevTotal);

                var subtotalRow = document.createElement('div');
                subtotalRow.className = 'row';
                subtotalRow.id = 'cartSubtotalRow';
                subtotalRow.innerHTML = '<div class="col text-end">Medzisúčet:</div><div class="col-auto"><strong>€' + totals.subtotal.toFixed(2) + '</strong></div>';
                parent.appendChild(subtotalRow);

                if (totals.discount > 0) {
                    var discountRow = document.createElement('div');
                    discountRow.className = 'row';
                    discountRow.id = 'cartDiscountRow';
                    discountRow.innerHTML = '<div class="col text-end" style="color:#d9534f;">Zľava 10% (len na produkty nad 50€):</div><div class="col-auto" style="color:#d9534f;"><strong>-€' + (totals.discount).toFixed(2) + '</strong></div>';
                    parent.appendChild(discountRow);
                }

                var totalRow = document.createElement('div');
                totalRow.className = 'row';
                totalRow.id = 'cartTotalRow';
                totalRow.innerHTML = '<div class="col text-end"><strong>Celková suma:</strong></div><div class="col-auto"><strong style="font-size:1.1em;">€' + totals.total.toFixed(2) + '</strong></div>';
                parent.appendChild(totalRow);

                totalEl.textContent = totals.total.toFixed(2);

                // Toggle visibility of cart review section
                var reviewEmpty = !hasItems;
                var reviewList = document.getElementById('cartReviewList');
                var reviewTotal = document.getElementById('cartReviewTotal');
                if (reviewEmpty) {
                    // Hide cart review elements
                    reviewList.innerHTML = '<li class="list-group-item text-center text-muted">Košík je prázdny</li>';
                    reviewTotal.innerText = '0.00';
                } else {
                    // Ensure cart review elements are visible
                    reviewList.classList.remove('d-none');
                    reviewTotal.classList.remove('d-none');
                }

                var cartCount = Object.keys(cart).reduce((sum, key) => sum + (cart[key].quantity || 0), 0);
                var cartCountEl = document.getElementById('cart-item-count');
                if (cartCountEl) {
                    cartCountEl.innerText = cartCount > 0 ? cartCount : '';
                }
            }

            // initial render
            render();
        })();
    </script>
}






















































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































